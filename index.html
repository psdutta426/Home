<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Parashar's Home Switch Control</title>

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #d9f3ff, #f9f9f9);
    }

    .container {
      position: relative;
      width: 90%;
      max-width: 450px;
      padding: 30px;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      text-align: center;
      backdrop-filter: blur(8px);
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.6s ease, transform 0.6s ease;
      z-index: 1;
    }

    .show { opacity: 1; transform: translateY(0); }

    .container::before {
      content: "";
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: url('https://raw.githubusercontent.com/psdutta426/Home/main/TheMathClassroom.jpg')
        no-repeat center center/cover;
      opacity: 0.25;
      z-index: -1;
    }

    h2 { color: #111; margin-bottom: 25px; font-weight: 600; }
    input {
      padding: 12px; width: 85%; margin: 10px 0;
      border-radius: 10px; border: 1px solid #ccc; font-size: 16px;
    }

    button {
      border: none; border-radius: 10px; padding: 15px;
      margin: 10px; font-size: 16px;
      transition: all 0.3s ease; cursor: pointer;
    }

    #loginBtn { width: 100%; background: #0078d7; color: white; }
    #loginBtn:hover { background: #005fa3; }

    .switch-grid {
      display: grid; grid-template-columns: repeat(2, 1fr);
      gap: 15px; margin-bottom: 15px;
    }

    .switch-grid .switch-btn:nth-child(5) { grid-column: 1 / -1; }

    .switch-btn {
      background: #f44336;
      color: white;
      font-weight: bold;
      border-radius: 15px;
      height: 60px;
      font-size: 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    .switch-btn.on {
      background: #4CAF50;
      box-shadow: 0 4px 12px rgba(76,175,80,0.5);
    }

    .action-btn {
      background: #0078d7;
      color: white;
      width: 45%;
    }

    .logout-btn {
      background: #555;
      color: white;
      width: 100%;
      margin-top: 10px;
    }

    #loginStatus { color: red; height: 20px; font-size: 14px; }

    /* Loading Screen */
    #loadingScreen {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      display: flex; align-items: center; justify-content: center;
      flex-direction: column;
      background: rgba(255, 255, 255, 0.95);
      font-size: 18px; color: #333;
      z-index: 999;
      opacity: 0; pointer-events: none;
      transition: opacity 0.5s ease;
    }
    #loadingScreen.show { opacity: 1; pointer-events: all; }

    .spinner {
      width: 30px; height: 30px;
      border: 3px solid #ccc;
      border-top-color: #0078d7;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 12px;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }
  </style>
</head>

<body>

  <!-- LOADING SCREEN -->
  <div id="loadingScreen">
    <div class="spinner"></div>
    <div>Checking sessionâ€¦</div>
  </div>

  <!-- LOGIN PAGE -->
  <div class="container" id="loginPage">
    <h2>Login</h2>
    <input type="text" id="username" placeholder="Username" />
    <input type="password" id="password" placeholder="Password" />
    <label><input type="checkbox" id="rememberMe"> Remember Me</label>
    <button id="loginBtn">Login</button>
    <div id="loginStatus"></div>
  </div>

  <!-- CONTROL PANEL -->
  <div class="container" id="controlPage" style="display:none;">
    <h2>Home Switch Control</h2>

    <div class="switch-grid">
      <button id="btn0" class="switch-btn" onclick="toggleSwitch(0)">Backup</button>
      <button id="btn1" class="switch-btn" onclick="toggleSwitch(1)">Tubelight</button>
      <button id="btn2" class="switch-btn" onclick="toggleSwitch(2)">Fan</button>
      <button id="btn3" class="switch-btn" onclick="toggleSwitch(3)">Bulb</button>
      <button id="btn4" class="switch-btn" onclick="toggleSwitch(4)">Plug</button>
    </div>

    <button class="action-btn" onclick="bulkUpdate('allOn', true)">All ON</button>
    <button class="action-btn" onclick="bulkUpdate('allOff', false)">All OFF</button>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>

  <script>
    const workerURL = "https://nodemcubittu.psdutta426.workers.dev";

    let authToken = null;
    let refreshInterval;

    const switches = [
      { id: "btn0", name: "Backup", pin: "v1" },
      { id: "btn1", name: "Tubelight", pin: "v2" },
      { id: "btn2", name: "Fan", pin: "v3" },
      { id: "btn3", name: "Bulb", pin: "v4" },
      { id: "btn4", name: "Plug", pin: "v5" }
    ];

    const loginBtn = document.getElementById("loginBtn");
    loginBtn.onclick = login;

    window.onload = autoLogin;

    /** AUTO LOGIN */
    async function autoLogin() {
      document.getElementById("loadingScreen").classList.add("show");

      const saved = localStorage.getItem("authToken");
      if (saved) {
        authToken = saved;
        try {
          await fetchWithAuth(`${workerURL}/status`);
          showControlPanel();
          return;
        } catch {}
      }

      setTimeout(() => {
        document.getElementById("loadingScreen").classList.remove("show");
        document.getElementById("loginPage").classList.add("show");
      }, 500);
    }

    /** FETCH WITH AUTH */
    async function fetchWithAuth(url, options = {}) {
      const headers = options.headers || {};
      if (authToken) headers["Authorization"] = `Bearer ${authToken}`;
      return fetch(url, { ...options, headers });
    }

    /** LOGIN */
    async function login() {
      const usernameVal = document.getElementById("username").value.trim();
      const passwordVal = document.getElementById("password").value.trim();
      const remember = document.getElementById("rememberMe").checked;

      const res = await fetch(`${workerURL}/login`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username: usernameVal, password: passwordVal })
      });

      if (!res.ok) {
        document.getElementById("loginStatus").innerText = "Invalid login.";
        return;
      }

      const data = await res.json();
      authToken = data.token;

      if (remember) localStorage.setItem("authToken", authToken);

      showControlPanel();
    }

    /** SHOW CONTROL PANEL */
    function showControlPanel() {
      document.getElementById("loginPage").style.display = "none";
      const panel = document.getElementById("controlPage");
      panel.style.display = "block";
      setTimeout(() => panel.classList.add("show"), 50);

      loadStatus();
      refreshInterval = setInterval(loadStatus, 2000);
    }

    /** LOAD STATUS */
    async function loadStatus() {
      try {
        const r = await fetchWithAuth(`${workerURL}/status`);
        const status = await r.json();

        switches.forEach(sw => {
          const btn = document.getElementById(sw.id);
          const v = status[sw.pin];
          const isOn = v === "0";

          btn.classList.toggle("on", isOn);
          btn.textContent = `${sw.name}: ${isOn ? "ON" : "OFF"}`;
        });
      } catch {}
    }

    /** TOGGLE SINGLE SWITCH */
    async function toggleSwitch(i) {
      const sw = switches[i];
      const btn = document.getElementById(sw.id);
      const currentlyOn = btn.classList.contains("on");
      const value = currentlyOn ? "1" : "0";

      btn.classList.toggle("on", !currentlyOn);
      btn.textContent = `${sw.name}: ${!currentlyOn ? "ON" : "OFF"}`;

      await fetchWithAuth(`${workerURL}/update`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ pin: sw.pin, value })
      });
    }

    /** BULK UPDATE FIXED VERSION */
    async function bulkUpdate(action, optimisticState) {
      // UI Update
      switches.forEach(sw => {
        const btn = document.getElementById(sw.id);
        btn.classList.toggle("on", optimisticState);
        btn.textContent = `${sw.name}: ${optimisticState ? "ON" : "OFF"}`;
      });

      try {
        await fetchWithAuth(`${workerURL}/${action}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: "{}"
        });
      } catch {
        alert("Bulk update failed");
        loadStatus();
      }
    }

    function logout() {
      clearInterval(refreshInterval);
      authToken = null;
      localStorage.removeItem("authToken");

      document.getElementById("controlPage").style.display = "none";
      document.getElementById("loginPage").style.display = "block";
    }
  </script>

</body>
</html>
